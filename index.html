<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Study Buddy – Auth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 560px; margin: auto; }
      .card { border: 1px solid #444; border-radius: 14px; padding: 22px; }
      h1 { font-size: 40px; margin-bottom: 18px; }
      input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #666; }
      button { cursor: pointer; }
      .hidden { display: none; }
      .error { border-color: #d9534f; }
      .success { border-color: #5cb85c; }
    </style>
  </head>
  <body>
    <script>
      console.log('At load, location.href =', location.href);
      console.log('At load, location.hash =', location.hash);
    </script>
    <h1>Study Buddy</h1>
    <div id="panel" class="card">
      <p id="status">Checking your link...</p>

      <form id="reset-form" class="hidden" autocomplete="off">
        <input id="pw1" type="password" placeholder="New password (min 8 chars)" required />
        <input id="pw2" type="password" placeholder="Confirm new password" required />
        <button type="submit">Update password</button>
      </form>

      <div id="done" class="hidden">
        <p>Password updated. You can close this page and sign in.</p>
      </div>
    </div>
    <script>
      // 1) Init
      const SUPABASE_URL = "https://twysxvxlybbyauhjtilh.supabase.co"
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3eXN4dnhseWJieWF1aGp0aWxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMjI4NzcsImV4cCI6MjA2Nzg5ODg3N30.hMDXzLs7VHVvRvWUwwb9WShp0AoMShgOb-_sMns3g2s"
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
      const statusEl = document.getElementById('status');
      const formEl   = document.getElementById('reset-form');
      const doneEl   = document.getElementById('done');
    
      (async () => {
        // 2) Read params from URL
        const hash = new URLSearchParams(location.hash.slice(1));
        const qs   = new URLSearchParams(location.search);
        const type = (hash.get('type') || qs.get('type') || '').toLowerCase();
        const code = qs.get('code');
        const accessToken  = hash.get('access_token');
        const refreshToken = hash.get('refresh_token');
    
        try {
          // 3) Establish a session using the *current* recommended methods
          if (code) {
            // PKCE/code flow
            const { error } = await sb.auth.exchangeCodeForSession(code);
            if (error) throw error;
          } else if (accessToken && refreshToken) {
            // Implicit/hash flow
            const { error } = await sb.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
            if (error) throw error;
          }
          // Prevent re-use on refresh
          history.replaceState({}, document.title, location.pathname + location.search);
    
          // 4) Show reset UI (you’re authenticated by now)
          if (type === 'recovery' || code) {
            statusEl.textContent = 'Enter your new password.';
            formEl.classList.remove('hidden');
          } else {
            statusEl.textContent = 'Email verified. You can sign in now.';
            doneEl.classList.remove('hidden');
          }
        } catch (e) {
          console.error(e);
          statusEl.textContent = 'This link is invalid or expired. Request a new one and try again.';
        }
      })();
    
      // 5) Submit new password
      document.getElementById('reset-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const p1 = document.getElementById('pw1').value.trim();
        const p2 = document.getElementById('pw2').value.trim();
        if (p1.length < 8) return statusEl.textContent = 'Password must be at least 8 characters.';
        if (p1 !== p2)     return statusEl.textContent = 'Passwords do not match.';
    
        const { error } = await sb.auth.updateUser({ password: p1 });
        if (error) return (statusEl.textContent = error.message || 'Failed to update password.');
        formEl.classList.add('hidden');
        doneEl.classList.remove('hidden');
      });
    </script>
  </body>
</html>
