<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Study Buddy â€“ Auth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 560px; margin: auto; }
      .card { border: 1px solid #444; border-radius: 14px; padding: 22px; }
      h1 { font-size: 40px; margin-bottom: 18px; }
      input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #666; }
      button { cursor: pointer; }
      .hidden { display: none; }
      .error { border-color: #d9534f; }
      .success { border-color: #5cb85c; }
    </style>
  </head>
  <body>
    <h1>Study Buddy</h1>
    <div id="panel" class="card">
      <p id="status">Checking your link...</p>

      <form id="reset-form" class="hidden" autocomplete="off">
        <input id="pw1" type="password" placeholder="New password (min 8 chars)" required />
        <input id="pw2" type="password" placeholder="Confirm new password" required />
        <button type="submit">Update password</button>
      </form>

      <div id="done" class="hidden">
        <p>Password updated. You can close this page and sign in.</p>
      </div>
    </div>

    <script>
      // --- Replace with your real keys ---
      const SUPABASE_URL = "https://twysxvxlybbyauhjtilh.supabase.co"
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3eXN4dnhseWJieWF1aGp0aWxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMjI4NzcsImV4cCI6MjA2Nzg5ODg3N30.hMDXzLs7VHVvRvWUwwb9WShp0AoMShgOb-_sMns3g2s"
      // -----------------------------------
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const panelEl  = document.getElementById('panel');
      const statusEl = document.getElementById('status');
      const formEl   = document.getElementById('reset-form');
      const doneEl   = document.getElementById('done');

      (async () => {
        // Stash link type BEFORE clearing hash
        const params = new URLSearchParams(location.hash.slice(1));
        const linkType = params.get('type'); // "recovery" | "signup" | "magiclink" | ...

        try {
          // Exchange OTP for a session (consumes once)
          const { error } = await client.auth.getSessionFromUrl({ storeSession: true });
          if (error) throw error;

          // Clear hash so refresh doesn't attempt to reuse OTP
          window.history.replaceState({}, document.title, location.pathname + location.search);

          if (linkType === 'recovery') {
            statusEl.textContent = 'Enter your new password.';
            formEl.classList.remove('hidden');

            formEl.addEventListener('submit', async (e) => {
              e.preventDefault();
              const p1 = document.getElementById('pw1').value.trim();
              const p2 = document.getElementById('pw2').value.trim();

              if (p1.length < 8) { statusEl.textContent = 'Password must be at least 8 characters.'; panelEl.classList.add('error'); return; }
              if (p1 !== p2)     { statusEl.textContent = 'Passwords do not match.';                panelEl.classList.add('error'); return; }

              const { error: upErr } = await client.auth.updateUser({ password: p1 });
              if (upErr) { statusEl.textContent = upErr.message || 'Failed to update password.'; panelEl.classList.add('error'); return; }

              formEl.classList.add('hidden');
              doneEl.classList.remove('hidden');
              panelEl.classList.remove('error'); panelEl.classList.add('success');
            });
          } else {
            statusEl.textContent = 'Email verified. You can sign in now.';
            doneEl.classList.remove('hidden');
            panelEl.classList.add('success');
          }
        } catch (e) {
          // e.message usually: "Email link is invalid or has expired"
          statusEl.textContent = 'This link is invalid or expired. Request a new one and try again.';
          panelEl.classList.add('error');
        }
      })();
    </script>
  </body>
</html>
